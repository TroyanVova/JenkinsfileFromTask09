pipeline {
    agent none

    stages {
        stage('Build') {
            agent { label 'VM2Agent' }
            steps {
                script {
                    def logFile = '/var/log/apache2/access.log'
                    if (!fileExists(logFile)) {
                        error "File ${logFile} does not exist!"
                    }

                    // Створюємо копію файлу з timestamp
                    def timestamp = new Date().format("yyyyMMdd_HHmmss")
                    def destFile = "${WORKSPACE}/access_${timestamp}.log"
                    sh "cp ${logFile} ${destFile}"
                    
                    // Архівуємо копію
                    archiveArtifacts artifacts: "access_${timestamp}.log", fingerprint: true
                    echo "Archived ${destFile} successfully."
                }
            }
        }

        stage('Test') {
            agent { label 'VM2Agent' }
            steps {
                echo "Running tests..."
                // Місце для реальних тестів
            }
        }

        stage('Deploy') {
			agent { label 'master' }
			steps {
				script {
					// Беремо останній архівований лог з workspace VM2Agent
					sh """
						latest_log=\$(ls -t ${WORKSPACE}/access_*.log | head -n1)
						mv \$latest_log /var/lib/jenkins/logs/
					"""
					echo "Deployed latest log file to master node"
				}
			}
		}

    }
}
